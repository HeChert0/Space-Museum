<!-- core/templates/core/employee_form_update.html -->
{% extends 'core/base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<a href="{% url 'employee_update' %}" class="back-button">‚Üê –ù–∞–∑–∞–¥</a>

<h1 class="menu-title">{{ operation }} —Ä–∞–±–æ—Ç–Ω–∏–∫–∞</h1>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}" style="
            padding: 10px;
            margin-bottom: 20px;
            border: 2px solid {% if message.tags == 'error' %}#ff0000{% else %}#00ff00{% endif %};
            color: {% if message.tags == 'error' %}#ff0000{% else %}#00ff00{% endif %};
            background: rgba({% if message.tags == 'error' %}255,0,0{% else %}0,255,0{% endif %}, 0.1);
        ">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<form method="post" class="entity-form" id="employeeForm">
    {% csrf_token %}

    <div class="form-group">
        <label for="full_name">–§–ò–û: <span class="required">*</span></label>
        <input type="text" name="full_name" id="full_name" required
               value="{{ fields_data.employee.full_name }}"
               placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á" maxlength="50">
        <small>–ú–∏–Ω–∏–º—É–º –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—è, —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã</small>
    </div>

    <div class="form-group">
        <label for="department">–û—Ç–¥–µ–ª: <span class="required">*</span></label>
        <select name="department" id="department" required>
            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª --</option>
            {% for dept in fields_data.departments %}
            <option value="{{ dept }}" {% if dept == fields_data.employee.department %}selected{% endif %}>
                {{ dept }}
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="position">–î–æ–ª–∂–Ω–æ—Å—Ç—å: <span class="required">*</span></label>
        <select name="position" id="position" required>
            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–ª–∂–Ω–æ—Å—Ç—å --</option>
        </select>
        <input type="hidden" id="current_position" value="{{ fields_data.employee.position }}">
        <input type="hidden" id="current_department" value="{{ fields_data.employee.department }}">
    </div>

    <div class="form-group">
        <label for="hire_date">–î–∞—Ç–∞ –Ω–∞–π–º–∞: <span class="required">*</span></label>
        <input type="text" name="hire_date" id="hire_date" required
               value="{{ fields_data.employee.hire_date|date:'d.m.Y' }}"
               class="date-input" placeholder="–î–î.–ú–ú.–ì–ì–ì–ì" maxlength="10">
    </div>

    <div class="form-group">
        <label>–¢–µ–ª–µ—Ñ–æ–Ω: <span class="required">*</span></label>
        <div style="display: flex; gap: 10px;">
            <select name="phone_code" id="phone_code" required style="width: 150px;">
                <option value="+7" {% if fields_data.phone_code == '+7' %}selected{% endif %}>üá∑üá∫ +7</option>
                <option value="+375" {% if fields_data.phone_code == '+375' %}selected{% endif %}>üáßüáæ +375</option>
            </select>
            <input type="tel" name="phone_number" id="phone_number" required
                   value="{{ fields_data.phone_number }}"
                   placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"
                   maxlength="{% if fields_data.phone_code == '+375' %}9{% else %}10{% endif %}">
        </div>
        <small id="phone_hint">
            {% if fields_data.phone_code == '+375' %}
                –ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π –Ω–æ–º–µ—Ä: 9 —Ü–∏—Ñ—Ä
            {% else %}
                –†–æ—Å—Å–∏–π—Å–∫–∏–π –Ω–æ–º–µ—Ä: 10 —Ü–∏—Ñ—Ä
            {% endif %}
        </small>
    </div>

    <div class="form-group">
        <label for="qualification">–ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è: <span class="required">*</span></label>
        <input type="text" name="qualification" id="qualification" required
               value="{{ fields_data.employee.qualification }}"
               placeholder="–í—ã—Å—à–µ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ" maxlength="70">
        <small>–¢–æ–ª—å–∫–æ –±—É–∫–≤—ã, 2-70 —Å–∏–º–≤–æ–ª–æ–≤</small>
    </div>

    <button type="submit" class="btn-submit">{{ operation }}</button>
</form>

<style>
    .required { color: #ff0000; }
    .error-field {
        border-color: #ff0000 !important;
        box-shadow: 0 0 10px rgba(255, 0, 0, 0.5) !important;
    }
    small { display: block; margin-top: 5px; font-size: 12px; color: #00ff00; opacity: 0.8; }
</style>

<script src="{% static 'core/js/validation.js' %}"></script>
<script>
    const positionsByDepartment = {{ fields_data.positions_by_department|safe }};

    function updatePositions(departmentValue, selectedPosition) {
        const positionSelect = document.getElementById('position');
        const positions = positionsByDepartment[departmentValue] || [];

        positionSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–ª–∂–Ω–æ—Å—Ç—å --</option>';

        if (positions.length > 0) {
            positionSelect.disabled = false;
            positions.forEach(pos => {
                const option = document.createElement('option');
                option.value = pos;
                option.textContent = pos;
                if (pos === selectedPosition) {
                    option.selected = true;
                }
                positionSelect.appendChild(option);
            });
        } else {
            positionSelect.disabled = true;
        }
    }

    // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–æ–ª–∂–Ω–æ—Å—Ç—å
    document.addEventListener('DOMContentLoaded', function() {
        const currentDepartment = document.getElementById('current_department').value;
        const currentPosition = document.getElementById('current_position').value;

        if (currentDepartment) {
            updatePositions(currentDepartment, currentPosition);
        }
    });

    document.getElementById('department').addEventListener('change', function() {
        updatePositions(this.value, null);
    });

    document.getElementById('phone_code').addEventListener('change', function() {
        const hint = document.getElementById('phone_hint');
        const phoneInput = document.getElementById('phone_number');
        if (this.value === '+375') {
            hint.textContent = '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π –Ω–æ–º–µ—Ä: 9 —Ü–∏—Ñ—Ä';
            phoneInput.maxLength = 9;
        } else {
            hint.textContent = '–†–æ—Å—Å–∏–π—Å–∫–∏–π –Ω–æ–º–µ—Ä: 10 —Ü–∏—Ñ—Ä';
            phoneInput.maxLength = 10;
        }
    });

    document.getElementById('phone_number').addEventListener('input', function() {
        this.value = this.value.replace(/\D/g, '');
        validatePhone(this, document.getElementById('phone_code').value);
    });
</script>
{% endblock %}