<!-- core/templates/core/table_add.html -->
{% extends 'core/base.html' %}

{% block content %}
<a href="{% url 'table_management' %}" class="back-button">‚Üê –ù–∞–∑–∞–¥</a>

<h1 class="menu-title">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É</h1>

<form method="post" class="entity-form">
    {% csrf_token %}

    <div class="form-group">
        <label for="table_name">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã:</label>
        <input type="text" name="table_name" id="table_name" required pattern="[a-z_][a-z0-9_]*"
               title="–¢–æ–ª—å–∫–æ —Å—Ç—Ä–æ—á–Ω—ã–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è">
    </div>

    <div class="form-group">
        <label>–ö–æ–ª–æ–Ω–∫–∏ —Ç–∞–±–ª–∏—Ü—ã:</label>
        <div id="columns-container">
            <!-- –ö–æ–ª–æ–Ω–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
        </div>
        <button type="button" onclick="addColumn()" class="btn-add-column">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É
        </button>
    </div>

    <div class="form-group">
        <label>–í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏ (Foreign Keys):</label>
        <div id="fk-container">
            <!-- Foreign keys –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
        </div>
        <button type="button" onclick="addForeignKey()" class="btn-add-fk">
            üîó –î–æ–±–∞–≤–∏—Ç—å Foreign Key
        </button>
    </div>

    <button type="submit" class="btn-submit">–°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É</button>
</form>

<style>
    .column-row, .fk-row {
        background-color: #001100;
        border: 1px solid #00ff00;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 5px;
    }

    .column-row:hover, .fk-row:hover {
        background-color: #002200;
    }

    .column-fields, .fk-fields {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin-bottom: 10px;
    }

    .field-group {
        display: flex;
        flex-direction: column;
    }

    .field-group label {
        color: #00ff00;
        font-size: 12px;
        margin-bottom: 3px;
    }

    .field-group input, .field-group select {
        padding: 5px;
        background-color: #000000;
        border: 1px solid #00ff00;
        color: #00ff00;
        font-family: 'Courier New', monospace;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .checkbox-group input[type="checkbox"] {
        width: auto;
        margin: 0;
    }

    .btn-remove {
        background: #ff0000;
        color: white;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 3px;
        float: right;
    }

    .btn-add-column, .btn-add-fk {
        background: #00ff00;
        color: black;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        border-radius: 3px;
        margin-top: 10px;
        font-weight: bold;
    }

    .btn-add-column:hover, .btn-add-fk:hover {
        background: #00dd00;
        box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
    }
</style>

<script>
    let columnCount = 0;
    let fkCount = 0;
    let existingTables = {{ existing_tables|safe }};

    function addColumn() {
        columnCount++;
        const container = document.getElementById('columns-container');
        const columnDiv = document.createElement('div');
        columnDiv.className = 'column-row';
        columnDiv.id = `column-${columnCount}`;

        columnDiv.innerHTML = `
            <button type="button" onclick="removeColumn(${columnCount})" class="btn-remove">‚úñ</button>
            <h4 style="color: #00ff00; margin-bottom: 10px;">–ö–æ–ª–æ–Ω–∫–∞ #${columnCount}</h4>
            <div class="column-fields">
                <div class="field-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏:</label>
                    <input type="text" name="column_name_${columnCount}" required
                           pattern="[a-z_][a-z0-9_]*">
                </div>
                <div class="field-group">
                    <label>–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö:</label>
                    <select name="column_type_${columnCount}" required>
                        <option value="INTEGER">INTEGER</option>
                        <option value="BIGINT">BIGINT</option>
                        <option value="VARCHAR(255)">VARCHAR(255)</option>
                        <option value="TEXT">TEXT</option>
                        <option value="DATE">DATE</option>
                        <option value="TIMESTAMP">TIMESTAMP</option>
                        <option value="BOOLEAN">BOOLEAN</option>
                        <option value="DECIMAL(10,2)">DECIMAL(10,2)</option>
                        <option value="FLOAT">FLOAT</option>
                        <option value="JSON">JSON</option>
                    </select>
                </div>
                <div class="field-group">
                    <label>–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="column_primary_${columnCount}"> PRIMARY KEY</label>
                        <label><input type="checkbox" name="column_notnull_${columnCount}"> NOT NULL</label>
                        <label><input type="checkbox" name="column_unique_${columnCount}"> UNIQUE</label>
                    </div>
                </div>
                <div class="field-group">
                    <label>–ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:</label>
                    <input type="text" name="column_default_${columnCount}" placeholder="NULL">
                </div>
            </div>
        `;

        container.appendChild(columnDiv);

        // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—É—é –∫–æ–ª–æ–Ω–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è
        if (columnCount === 1) {
            // –ú–æ–∂–Ω–æ –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–∏—Ç—å id –∫–æ–ª–æ–Ω–∫—É
            document.querySelector(`input[name="column_name_1"]`).value = 'id';
            document.querySelector(`select[name="column_type_1"]`).value = 'INTEGER';
            document.querySelector(`input[name="column_primary_1"]`).checked = true;
        }
    }

    function removeColumn(id) {
        const element = document.getElementById(`column-${id}`);
        if (element) element.remove();
    }

    function addForeignKey() {
        fkCount++;
        const container = document.getElementById('fk-container');
        const fkDiv = document.createElement('div');
        fkDiv.className = 'fk-row';
        fkDiv.id = `fk-${fkCount}`;

        let tableOptions = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É --</option>';
        existingTables.forEach(table => {
            tableOptions += `<option value="${table}">${table}</option>`;
        });

        fkDiv.innerHTML = `
            <button type="button" onclick="removeForeignKey(${fkCount})" class="btn-remove">‚úñ</button>
            <h4 style="color: #00ff00; margin-bottom: 10px;">Foreign Key #${fkCount}</h4>
            <div class="fk-fields">
                <div class="field-group">
                    <label>–õ–æ–∫–∞–ª—å–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞:</label>
                    <input type="text" name="fk_column_${fkCount}" required
                           placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: user_id">
                </div>
                <div class="field-group">
                    <label>–°—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ —Ç–∞–±–ª–∏—Ü—É:</label>
                    <select name="fk_ref_table_${fkCount}" required onchange="loadTableColumns(${fkCount})">
                        ${tableOptions}
                    </select>
                </div>
                <div class="field-group">
                    <label>–°—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ –∫–æ–ª–æ–Ω–∫—É:</label>
                    <select name="fk_ref_column_${fkCount}" id="fk_ref_column_${fkCount}" required>
                        <option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É --</option>
                    </select>
                </div>
                <div class="field-group">
                    <label>–ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:</label>
                    <select name="fk_on_delete_${fkCount}">
                        <option value="CASCADE">CASCADE</option>
                        <option value="SET NULL">SET NULL</option>
                        <option value="RESTRICT">RESTRICT</option>
                        <option value="NO ACTION">NO ACTION</option>
                    </select>
                </div>
            </div>
        `;

        container.appendChild(fkDiv);
    }

    function removeForeignKey(id) {
        const element = document.getElementById(`fk-${id}`);
        if (element) element.remove();
    }

    function loadTableColumns(fkId) {
        const tableSelect = document.querySelector(`select[name="fk_ref_table_${fkId}"]`);
        const columnSelect = document.getElementById(`fk_ref_column_${fkId}`);
        const tableName = tableSelect.value;

        if (!tableName) {
            columnSelect.innerHTML = '<option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É --</option>';
            return;
        }

        // AJAX –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
        fetch(`/get-table-columns/?table=${tableName}`)
            .then(response => response.json())
            .then(data => {
                let options = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–æ–Ω–∫—É --</option>';
                data.columns.forEach(col => {
                    options += `<option value="${col}">${col}</option>`;
                });
                columnSelect.innerHTML = options;
            })
            .catch(error => {
                console.error('Error:', error);
                columnSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–ª–æ–Ω–æ–∫</option>';
            });
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—É—é –∫–æ–ª–æ–Ω–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.onload = function() {
        addColumn();
    };
</script>
{% endblock %}