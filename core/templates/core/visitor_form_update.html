<!-- core/templates/core/visitor_form_update.html -->
{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<a href="{% url 'visitor_update' %}" class="back-button">← Назад</a>

<h1 class="menu-title">{{ operation }} посетителя</h1>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}" style="
            padding: 10px;
            margin-bottom: 20px;
            border: 2px solid {% if message.tags == 'error' %}#ff0000{% else %}#00ff00{% endif %};
            color: {% if message.tags == 'error' %}#ff0000{% else %}#00ff00{% endif %};
            background: rgba({% if message.tags == 'error' %}255,0,0{% else %}0,255,0{% endif %}, 0.1);
        ">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<form method="post" class="entity-form" id="visitorForm">
    {% csrf_token %}

    <div class="form-group">
        <label for="full_name">ФИО: <span class="required">*</span></label>
        <input type="text" name="full_name" id="full_name" required
               value="{{ fields_data.visitor.full_name }}"
               placeholder="Иванов Иван Иванович" maxlength="50">
        <small>Минимум имя и фамилия, только буквы и дефис</small>
    </div>

    <div class="form-group">
        <label for="birth_date">Дата рождения: <span class="required">*</span></label>
        <input type="text" name="birth_date" id="birth_date" required
               value="{{ fields_data.visitor.birth_date|date:'d.m.Y' }}"
               class="date-input" placeholder="ДД.ММ.ГГГГ" maxlength="10">
    </div>

    <div class="form-group">
        <label for="citizenship">Гражданство: <span class="required">*</span></label>
        <select name="citizenship" id="citizenship" required>
            <option value="">-- Выберите страну --</option>
            {% for country in fields_data.countries %}
            <option value="{{ country }}" {% if country == fields_data.visitor.citizenship %}selected{% endif %}>
                {{ country }}
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="ticket_type">Тип билета: <span class="required">*</span></label>
        <select name="ticket_type" id="ticket_type" required>
            <option value="">-- Выберите тип --</option>
            {% for ticket in fields_data.ticket_types %}
            <option value="{{ ticket }}" {% if ticket == fields_data.visitor.ticket_type %}selected{% endif %}>
                {{ ticket }}
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="visit_date">Дата посещения: <span class="required">*</span></label>
        <input type="text" name="visit_date" id="visit_date" required
               value="{{ fields_data.visitor.visit_date|date:'d.m.Y' }}"
               class="date-input" placeholder="ДД.ММ.ГГГГ" maxlength="10">
    </div>

    <div class="form-group">
        <label for="review">Отзыв:</label>
        <textarea name="review" id="review" maxlength="100"
                  placeholder="Ваш отзыв (необязательно, до 100 символов)">{{ fields_data.visitor.review|default:'' }}</textarea>
        <small>Осталось символов: <span id="reviewCharsLeft">{{ 100|add:'-'|add:fields_data.visitor.review|length|default:100 }}</span></small>
    </div>

    <button type="submit" class="btn-submit">{{ operation }}</button>
</form>

<style>
    .required { color: #ff0000; }
    small { display: block; margin-top: 5px; font-size: 12px; color: #00ff00; opacity: 0.8; }
</style>

<script src="{% static 'core/js/validation.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Валидация ФИО
        const fioInput = document.getElementById('full_name');
        restrictFIOInput(fioInput);

        // Валидация дат
        const birthDateInput = document.getElementById('birth_date');
        const visitDateInput = document.getElementById('visit_date');

        // Форматирование и валидация даты рождения
        birthDateInput.addEventListener('input', function() {
            formatDateInput(this);
        });

        birthDateInput.addEventListener('blur', function() {
            if (this.value.length === 10) {
                validateDate(this);
            }
        });

        birthDateInput.addEventListener('keypress', function(e) {
            const char = String.fromCharCode(e.which || e.keyCode);
            if (!/\d/.test(char)) {
                e.preventDefault();
                return false;
            }
        });

        // Форматирование и валидация даты посещения
        visitDateInput.addEventListener('input', function() {
            formatDateInput(this);
        });

        visitDateInput.addEventListener('blur', function() {
            if (this.value.length === 10) {
                validateDate(this);
            }
        });

        visitDateInput.addEventListener('keypress', function(e) {
            const char = String.fromCharCode(e.which || e.keyCode);
            if (!/\d/.test(char)) {
                e.preventDefault();
                return false;
            }
        });

        // Валидация отзыва
        const reviewInput = document.getElementById('review');
        const reviewCounter = document.getElementById('reviewCharsLeft');

        // Инициализация счетчика
        const currentLength = reviewInput.value.length;
        reviewCounter.textContent = 100 - currentLength;

        reviewInput.addEventListener('input', function() {
            const left = 100 - this.value.length;
            reviewCounter.textContent = left;

            const value = this.value.trim();
            if (value && value.length < 5) {
                showFieldError(this, 'Отзыв слишком короткий (минимум 5 символов)');
            } else if (value && /^[!@#$%^&*()_+=\-\s]+$/.test(value)) {
                showFieldError(this, 'Отзыв не может состоять только из специальных символов');
            } else {
                clearFieldError(this);
            }
        });
    });
</script>
{% endblock %}