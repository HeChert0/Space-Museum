<!-- core/templates/core/mission_form_add.html -->
{% extends 'core/base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<a href="{% url 'entities_menu' %}" class="back-button">← Назад</a>

<h1 class="menu-title">{{ operation }} миссию</h1>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}" style="
            padding: 10px;
            margin-bottom: 20px;
            border: 2px solid {% if message.tags == 'error' %}#ff0000{% else %}#00ff00{% endif %};
            color: {% if message.tags == 'error' %}#ff0000{% else %}#00ff00{% endif %};
            background: rgba({% if message.tags == 'error' %}255,0,0{% else %}0,255,0{% endif %}, 0.1);
        ">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<form method="post" class="entity-form" id="missionForm">
    {% csrf_token %}

    <div class="form-group">
        <label for="title">Название: <span class="required">*</span></label>
        <input type="text" name="title" id="title" required
               value="{{ fields_data.form_data.title|default:'' }}"
               {% if fields_data.error_field == 'title' %}class="error-field"{% endif %}
               placeholder="Аполлон-11" maxlength="50">
        <small>Буквы, цифры, дефис и скобки, 2-50 символов</small>
    </div>

    <div class="form-group">
        <label>Страны (до 5): <span class="required">*</span></label>
        <div class="checkbox-group" {% if fields_data.error_field == 'countries' %}style="border: 2px solid #ff0000; padding: 10px;"{% endif %}>
            {% for country in fields_data.countries %}
            <label class="checkbox-label">
                <input type="checkbox" name="countries[]" value="{{ country }}"
                       {% if country in fields_data.form_data.countries %}checked{% endif %}>
                {{ country }}
            </label>
            {% endfor %}
        </div>
        <small>Выберите от 1 до 5 стран</small>
    </div>

    <div class="form-group">
        <label for="start_date">Дата начала: <span class="required">*</span></label>
        <input type="text" name="start_date" id="start_date" required
               value="{{ fields_data.form_data.start_date|default:'' }}"
               {% if fields_data.error_field == 'start_date' %}class="error-field date-input"{% else %}class="date-input"{% endif %}
               placeholder="ДД.ММ.ГГГГ" maxlength="10">
    </div>

    <div class="form-group">
        <label for="end_date">Дата окончания:</label>
        <input type="text" name="end_date" id="end_date"
               value="{{ fields_data.form_data.end_date|default:'' }}"
               {% if fields_data.error_field == 'end_date' %}class="error-field date-input"{% else %}class="date-input"{% endif %}
               placeholder="ДД.ММ.ГГГГ или оставьте пустым" maxlength="10">
        <small>Можно оставить пустым для текущих миссий</small>
    </div>

    <div class="form-group">
        <label>Экипаж:</label>
        <div id="crew-container" {% if fields_data.error_field == 'crew' %}class="error-field"{% endif %}>
            {% if fields_data.form_data.crew %}
                {% for member in fields_data.form_data.crew %}
                <div class="crew-member-row">
                    <input type="text" name="crew[]" value="{{ member }}" placeholder="ФИО члена экипажа">
                    <button type="button" onclick="removeCrewMember(this)" class="btn-remove-crew">❌</button>
                </div>
                {% endfor %}
            {% endif %}
        </div>
        <button type="button" onclick="addCrewMember()" class="btn-add-crew">➕ Добавить члена экипажа</button>
    </div>

    <div class="form-group">
        <label for="goal">Цель миссии: <span class="required">*</span></label>
        <textarea name="goal" id="goal" required maxlength="100" minlength="10"
                  {% if fields_data.error_field == 'goal' %}class="error-field"{% endif %}
                  placeholder="Описание цели миссии (10-100 символов)">{{ fields_data.form_data.goal|default:'' }}</textarea>
        <small>Осталось символов: <span id="goalCharsLeft">100</span></small>
    </div>

    <button type="submit" class="btn-submit">{{ operation }}</button>
</form>

<style>
    .checkbox-group {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-top: 10px;
    }
    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .crew-member-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }
    .crew-member-row input {
        flex: 1;
    }
    .error-field {
        border-color: #ff0000 !important;
        box-shadow: 0 0 10px rgba(255, 0, 0, 0.5) !important;
    }
    .required { color: #ff0000; }
    small { display: block; margin-top: 5px; font-size: 12px; color: #00ff00; opacity: 0.8; }
</style>

<script src="{% static 'core/js/validation.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Валидация названия миссии
        const titleInput = document.getElementById('title');
        restrictMissionTitleInput(titleInput);

        // Валидация дат
        const startDateInput = document.getElementById('start_date');
        const endDateInput = document.getElementById('end_date');

        // Форматирование даты начала
        startDateInput.addEventListener('input', function() {
            formatDateInput(this);
        });

        startDateInput.addEventListener('blur', function() {
            if (this.value.length === 10) {
                validateDate(this);
            }
        });

        startDateInput.addEventListener('keypress', function(e) {
            const char = String.fromCharCode(e.which || e.keyCode);
            if (!/\d/.test(char)) {
                e.preventDefault();
                return false;
            }
        });

        // Форматирование даты окончания
        endDateInput.addEventListener('input', function() {
            formatDateInput(this);
        });

        endDateInput.addEventListener('blur', function() {
            if (this.value.length === 10) {
                validateDate(this);

                // Проверка, что дата окончания не раньше даты начала
                const startValue = startDateInput.value;
                if (startValue && this.value) {
                    const [sDay, sMonth, sYear] = startValue.split('.');
                    const [eDay, eMonth, eYear] = this.value.split('.');

                    const startDate = new Date(sYear, sMonth - 1, sDay);
                    const endDate = new Date(eYear, eMonth - 1, eDay);

                    if (endDate < startDate) {
                        showFieldError(this, 'Дата окончания не может быть раньше даты начала');
                    }
                }
            }
        });

        endDateInput.addEventListener('keypress', function(e) {
            const char = String.fromCharCode(e.which || e.keyCode);
            if (!/\d/.test(char)) {
                e.preventDefault();
                return false;
            }
        });

        // Валидация цели
        const goalField = document.getElementById('goal');
        const counter = document.getElementById('goalCharsLeft');

        counter.textContent = 100 - goalField.value.length;

        goalField.addEventListener('input', function() {
            counter.textContent = 100 - this.value.length;

            const value = this.value.trim();
            if (value.length < 10 && value.length > 0) {
                showFieldError(this, 'Минимум 10 символов');
            } else if (value.length > 100) {
                showFieldError(this, 'Максимум 100 символов');
            } else {
                clearFieldError(this);
            }
        });

        // Валидация членов экипажа
        const crewInputs = document.querySelectorAll('input[name="crew[]"]');
        crewInputs.forEach(input => {
            restrictFIOInput(input);
        });

        // Проверка количества выбранных стран
        document.querySelectorAll('input[name="countries[]"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const checked = document.querySelectorAll('input[name="countries[]"]:checked').length;
                if (checked > 5) {
                    this.checked = false;
                    alert('Можно выбрать максимум 5 стран');
                } else if (checked === 0) {
                    document.querySelector('.checkbox-group').style.borderColor = '#ff0000';
                } else {
                    document.querySelector('.checkbox-group').style.borderColor = 'transparent';
                }
            });
        });
    });

    function addCrewMember() {
        const container = document.getElementById('crew-container');
        if (container.children.length >= 20) {
            alert('Максимум 20 членов экипажа');
            return;
        }

        const row = document.createElement('div');
        row.className = 'crew-member-row';
        row.innerHTML = '<input type="text" name="crew[]" placeholder="ФИО члена экипажа">' +
                       '<button type="button" onclick="removeCrewMember(this)" class="btn-remove-crew">❌</button>';
        container.appendChild(row);

        // Применяем валидацию к новому полю
        const newInput = row.querySelector('input[name="crew[]"]');
        restrictFIOInput(newInput);
    }

    function removeCrewMember(button) {
        button.parentElement.remove();
    }
</script>
{% endblock %}