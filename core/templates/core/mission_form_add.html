{% extends 'core/base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<a href="{% url 'entities_menu' %}" class="back-button">← Назад</a>

<h1 class="menu-title">{{ operation }} миссию</h1>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}" style="
            padding: 10px;
            margin-bottom: 20px;
            border: 2px solid {% if message.tags == 'error' %}#ff0000{% else %}#00ff00{% endif %};
            color: {% if message.tags == 'error' %}#ff0000{% else %}#00ff00{% endif %};
            background: rgba({% if message.tags == 'error' %}255,0,0{% else %}0,255,0{% endif %}, 0.1);
        ">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<form method="post" class="entity-form" id="missionForm">
    {% csrf_token %}

    <div class="form-group">
        <label for="title">Название: <span class="required">*</span></label>
        <input type="text" name="title" id="title" required
               value="{{ fields_data.form_data.title|default:'' }}"
               {% if fields_data.error_field == 'title' %}class="error-field"{% endif %}
               placeholder="Аполлон-11" maxlength="50">
        <small>Буквы, цифры, дефис и скобки, 2-50 символов</small>
    </div>

    <div class="form-group">
        <label>Страны (до 5): <span class="required">*</span></label>
        <div class="checkbox-group" {% if fields_data.error_field == 'countries' %}style="border: 2px solid #ff0000; padding: 10px;"{% endif %}>
            {% for country in fields_data.countries %}
            <label class="checkbox-label">
                <input type="checkbox" name="countries[]" value="{{ country }}"
                       {% if country in fields_data.form_data.countries %}checked{% endif %}>
                {{ country }}
            </label>
            {% endfor %}
        </div>
        <small>Выберите от 1 до 5 стран</small>
    </div>

    <div class="form-group">
        <label for="start_date">Дата начала: <span class="required">*</span></label>
        <input type="date" name="start_date" id="start_date" required
               min="1957-10-04" max="" class="date-calendar"
               readonly onfocus="this.removeAttribute('readonly')"
               onblur="this.setAttribute('readonly', true)">
        <div class="field-error" id="start_date_error"></div>
        <small id="start_date_hint">Первая миссия: Спутник-1 (4 октября 1957)</small>
    </div>

    <div class="form-group">
        <label for="end_date">Дата окончания:</label>
        <input type="date" name="end_date" id="end_date"
               min="1957-10-04" max="" class="date-calendar"
               readonly onfocus="this.removeAttribute('readonly')"
               onblur="this.setAttribute('readonly', true)"
               disabled>
        <div class="field-error" id="end_date_error"></div>
        <small>Можно оставить пустым для текущих миссий</small>
        <small id="mission_duration" style="display: none;">Продолжительность: <span id="duration_text"></span></small>
    </div>

    <div class="form-group">
        <label>Экипаж:</label>
        <div id="crew-container" {% if fields_data.error_field == 'crew' %}class="error-field"{% endif %}>
            {% if fields_data.form_data.crew %}
                {% for member in fields_data.form_data.crew %}
                <div class="crew-member-row">
                    <input type="text" name="crew[]" value="{{ member }}" placeholder="ФИО члена экипажа">
                    <button type="button" onclick="removeCrewMember(this)" class="btn-remove-crew">❌</button>
                </div>
                {% endfor %}
            {% endif %}
        </div>
        <button type="button" onclick="addCrewMember()" class="btn-add-crew">➕ Добавить члена экипажа</button>
    </div>

    <div class="form-group">
        <label for="goal">Цель миссии: <span class="required">*</span></label>
        <textarea name="goal" id="goal" required maxlength="100" minlength="10"
                  {% if fields_data.error_field == 'goal' %}class="error-field"{% endif %}
                  placeholder="Описание цели миссии (10-100 символов)">{{ fields_data.form_data.goal|default:'' }}</textarea>
        <small>Осталось символов: <span id="goalCharsLeft">100</span></small>
    </div>

    <button type="submit" class="btn-submit">{{ operation }}</button>
</form>

<style>
    .checkbox-group {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-top: 10px;
        padding: 10px;
        border: 1px solid #00ff00;
        background: rgba(0, 255, 0, 0.05);
    }
    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
    }
    .crew-member-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }
    .crew-member-row input {
        flex: 1;
    }
    .error-field {
        border-color: #ff0000 !important;
        box-shadow: 0 0 10px rgba(255, 0, 0, 0.5) !important;
    }
    .required { color: #ff0000; }
    small {
        display: block;
        margin-top: 5px;
        font-size: 12px;
        color: #00ff00;
        opacity: 0.8;
    }

    .date-calendar {
        cursor: pointer;
        background: #1a1a1a;
        color: #00ff00;
        border: 1px solid #00ff00;
        padding: 10px;
        font-family: 'Courier New', monospace;
        width: 100%;
        position: relative;
    }

    .date-calendar::-webkit-calendar-picker-indicator {
        filter: invert(1);
        cursor: pointer;
        position: absolute;
        right: 10px;
        width: 20px;
        height: 20px;
    }

    .date-calendar:hover {
        box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
    }

    .date-calendar[readonly] {
        cursor: pointer;
        background: #1a1a1a;
    }

    .date-calendar:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .date-calendar {
        caret-color: transparent;
    }

    .field-error {
        color: #ff0000;
        font-size: 12px;
        margin-top: 5px;
        display: none;
    }

    .field-error.show {
        display: block;
    }

    input.error, textarea.error {
        border-color: #ff0000 !important;
        box-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
    }

    input.valid, textarea.valid {
        border-color: #00ff00 !important;
    }

    .btn-remove-crew {
        background: #001100;
        border: 1px solid #ff0000;
        color: #ff0000;
        padding: 5px 10px;
        cursor: pointer;
    }

    .btn-add-crew {
        background: #001100;
        border: 1px solid #00ff00;
        color: #00ff00;
        padding: 8px 15px;
        cursor: pointer;
        margin-top: 10px;
    }
</style>

<script src="{% static 'core/js/validation.js' %}"></script>
<script>
    // Функции для показа/скрытия ошибок
    function showFieldError(input, message) {
        const errorDiv = document.getElementById(input.id + '_error');
        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }
        input.classList.add('error');
        input.classList.remove('valid');
    }

    function clearFieldError(input) {
        const errorDiv = document.getElementById(input.id + '_error');
        if (errorDiv) {
            errorDiv.textContent = '';
            errorDiv.classList.remove('show');
        }
        input.classList.remove('error');
        input.classList.add('valid');
    }

    // Функция для расчета продолжительности миссии
    function calculateMissionDuration(startDate, endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        const diffTime = Math.abs(end - start);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays < 30) {
            return `${diffDays} дней`;
        } else if (diffDays < 365) {
            const months = Math.floor(diffDays / 30);
            return `${months} месяцев`;
        } else {
            const years = Math.floor(diffDays / 365);
            return `${years} лет`;
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Устанавливаем максимальную дату (сегодня)
        const today = new Date().toISOString().split('T')[0];

        // Валидация названия миссии
        const titleInput = document.getElementById('title');
        restrictMissionTitleInput(titleInput);

        // Настройка календарей
        const startDateInput = document.getElementById('start_date');
        const endDateInput = document.getElementById('end_date');
        const missionDuration = document.getElementById('mission_duration');
        const durationText = document.getElementById('duration_text');

        if (startDateInput) {
            startDateInput.max = today;

            // Блокируем ввод с клавиатуры
            startDateInput.addEventListener('keydown', function(e) {
                if (e.key !== 'Tab') {
                    e.preventDefault();
                }
            });

            startDateInput.addEventListener('paste', function(e) {
                e.preventDefault();
            });

            // При изменении даты начала
            startDateInput.addEventListener('change', function() {
                if (!this.value) {
                    showFieldError(this, 'Выберите дату начала миссии');
                    endDateInput.disabled = true;
                    endDateInput.value = '';
                    missionDuration.style.display = 'none';
                    return;
                }

                const selectedDate = new Date(this.value);
                const minDate = new Date('1957-10-04');
                const maxDate = new Date();

                if (selectedDate < minDate) {
                    showFieldError(this, 'Первая космическая миссия - Спутник-1 (4 октября 1957)');
                    this.value = '';
                    endDateInput.disabled = true;
                    return;
                }

                if (selectedDate > maxDate) {
                    showFieldError(this, 'Дата начала не может быть в будущем');
                    this.value = '';
                    endDateInput.disabled = true;
                    return;
                }

                clearFieldError(this);

                // Активируем поле даты окончания
                endDateInput.disabled = false;
                endDateInput.min = this.value;

                // Обновляем подсказку
                const year = selectedDate.getFullYear();
                let era = '';
                if (year >= 1957 && year < 1961) {
                    era = 'Эра первых спутников';
                } else if (year >= 1961 && year < 1970) {
                    era = 'Первые полеты человека';
                } else if (year >= 1970 && year < 1980) {
                    era = 'Эра космических станций';
                } else if (year >= 1980 && year < 1990) {
                    era = 'Развитие шаттлов';
                } else if (year >= 1990 && year < 2000) {
                    era = 'Международное сотрудничество';
                } else if (year >= 2000) {
                    era = 'Современная космонавтика';
                }

                if (era) {
                    document.getElementById('start_date_hint').textContent = era;
                }

                // Пересчитываем продолжительность если дата окончания уже выбрана
                if (endDateInput.value) {
                    const duration = calculateMissionDuration(this.value, endDateInput.value);
                    durationText.textContent = duration;
                    missionDuration.style.display = 'block';
                }
            });
        }

        if (endDateInput) {
            endDateInput.max = today;

            // Блокируем ввод с клавиатуры
            endDateInput.addEventListener('keydown', function(e) {
                if (e.key !== 'Tab') {
                    e.preventDefault();
                }
            });

            endDateInput.addEventListener('paste', function(e) {
                e.preventDefault();
            });

            // Блокируем выбор до даты начала
            endDateInput.addEventListener('focus', function() {
                if (!startDateInput.value) {
                    this.blur();
                    showFieldError(startDateInput, 'Сначала выберите дату начала');
                    showFieldError(this, 'Выберите дату начала миссии');
                }
            });

            // При изменении даты окончания
            endDateInput.addEventListener('change', function() {
                if (!this.value) {
                    // Можно оставить пустым
                    clearFieldError(this);
                    missionDuration.style.display = 'none';
                    return;
                }

                if (!startDateInput.value) {
                    showFieldError(this, 'Сначала выберите дату начала');
                    this.value = '';
                    return;
                }

                const startDate = new Date(startDateInput.value);
                const endDate = new Date(this.value);
                const maxDate = new Date();

                if (endDate < startDate) {
                    showFieldError(this, 'Дата окончания не может быть раньше даты начала');
                    this.value = '';
                    missionDuration.style.display = 'none';
                    return;
                }

                if (endDate > maxDate) {
                    showFieldError(this, 'Дата окончания не может быть в будущем');
                    this.value = '';
                    missionDuration.style.display = 'none';
                    return;
                }

                clearFieldError(this);

                // Показываем продолжительность
                const duration = calculateMissionDuration(startDateInput.value, this.value);
                durationText.textContent = duration;
                missionDuration.style.display = 'block';
            });
        }

        // Валидация цели
        const goalField = document.getElementById('goal');
        const counter = document.getElementById('goalCharsLeft');

        counter.textContent = 100 - goalField.value.length;

        goalField.addEventListener('input', function() {
            counter.textContent = 100 - this.value.length;

            const value = this.value.trim();
            if (value.length < 10 && value.length > 0) {
                showFieldError(this, 'Минимум 10 символов');
            } else if (value.length > 100) {
                showFieldError(this, 'Максимум 100 символов');
            } else {
                clearFieldError(this);
            }
        });

        // Валидация членов экипажа
        const crewInputs = document.querySelectorAll('input[name="crew[]"]');
        crewInputs.forEach(input => {
            restrictFIOInput(input);
        });

        // Проверка количества выбранных стран
        document.querySelectorAll('input[name="countries[]"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const checked = document.querySelectorAll('input[name="countries[]"]:checked').length;
                if (checked > 5) {
                    this.checked = false;
                    alert('Можно выбрать максимум 5 стран');
                } else if (checked === 0) {
                    document.querySelector('.checkbox-group').style.borderColor = '#ff0000';
                } else {
                    document.querySelector('.checkbox-group').style.borderColor = '#00ff00';
                }
            });
        });
    });

    function addCrewMember() {
        const container = document.getElementById('crew-container');
        if (container.children.length >= 20) {
            alert('Максимум 20 членов экипажа');
            return;
        }

        const row = document.createElement('div');
        row.className = 'crew-member-row';
        row.innerHTML = '<input type="text" name="crew[]" placeholder="ФИО члена экипажа">' +
                       '<button type="button" onclick="removeCrewMember(this)" class="btn-remove-crew">❌</button>';
        container.appendChild(row);

        // Применяем валидацию к новому полю
        const newInput = row.querySelector('input[name="crew[]"]');
        restrictFIOInput(newInput);
    }

    function removeCrewMember(button) {
        button.parentElement.remove();
    }
</script>
{% endblock %}