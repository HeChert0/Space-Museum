<!-- core/templates/core/exhibition_form_update.html -->
{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<a href="{% url 'exhibition_update' %}" class="back-button">← Назад</a>

<h1 class="menu-title">{{ operation }} выставку</h1>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}" style="
            padding: 10px;
            margin-bottom: 20px;
            border: 2px solid {% if message.tags == 'error' %}#ff0000{% else %}#00ff00{% endif %};
            color: {% if message.tags == 'error' %}#ff0000{% else %}#00ff00{% endif %};
            background: rgba({% if message.tags == 'error' %}255,0,0{% else %}0,255,0{% endif %}, 0.1);
        ">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<form method="post" class="entity-form" id="exhibitionForm">
    {% csrf_token %}

    <div class="form-group">
        <label for="title">Название: <span class="required">*</span></label>
        <input type="text" name="title" id="title" required
               value="{{ fields_data.exhibition.title }}"
               placeholder="Название выставки" maxlength="50">
        <small>Только буквы, 2-50 символов</small>
    </div>

    <div class="form-group">
        <label for="theme">Тема: <span class="required">*</span></label>
        <input type="text" name="theme" id="theme" required
               value="{{ fields_data.exhibition.theme }}"
               placeholder="Тема выставки" maxlength="50">
        <small>Только буквы, 2-50 символов</small>
    </div>

    <div class="form-group">
        <label for="start_date">Дата начала: <span class="required">*</span></label>
        <input type="text" name="start_date" id="start_date" required
               value="{{ fields_data.exhibition.start_date|date:'d.m.Y' }}"
               class="date-input" placeholder="ДД.ММ.ГГГГ" maxlength="10">
    </div>

    <div class="form-group">
        <label for="end_date">Дата окончания: <span class="required">*</span></label>
        <input type="text" name="end_date" id="end_date" required
               value="{{ fields_data.exhibition.end_date|date:'d.m.Y' }}"
               class="date-input" placeholder="ДД.ММ.ГГГГ" maxlength="10">
    </div>

    <div class="form-group">
        <label for="location">Место проведения: <span class="required">*</span></label>
        <select name="location" id="location" required>
            <option value="">-- Выберите место --</option>
            {% for loc in fields_data.locations %}
            <option value="{{ loc }}" {% if loc == fields_data.exhibition.location %}selected{% endif %}>
                {{ loc }}
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="type">Тип выставки: <span class="required">*</span></label>
        <select name="type" id="type" required>
            <option value="">-- Выберите тип --</option>
            {% for t in fields_data.types %}
            <option value="{{ t }}" {% if t == fields_data.exhibition.type %}selected{% endif %}>
                {{ t }}
            </option>
            {% endfor %}
        </select>
    </div>

    <button type="submit" class="btn-submit">{{ operation }}</button>
</form>

<style>
    .required { color: #ff0000; }
    .error-field {
        border-color: #ff0000 !important;
        box-shadow: 0 0 10px rgba(255, 0, 0, 0.5) !important;
    }
    small { display: block; margin-top: 5px; font-size: 12px; color: #00ff00; opacity: 0.8; }
</style>

<script src="{% static 'core/js/validation.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Валидация названия
        const titleInput = document.getElementById('title');
        restrictExhibitionTitleInput(titleInput);

        // Валидация темы
        const themeInput = document.getElementById('theme');
        restrictExhibitionTitleInput(themeInput);

        // Валидация дат
        const startDateInput = document.getElementById('start_date');
        const endDateInput = document.getElementById('end_date');

        // Форматирование и валидация даты начала
        startDateInput.addEventListener('input', function() {
            formatDateInput(this);
        });

        startDateInput.addEventListener('blur', function() {
            if (this.value.length === 10) {
                validateDate(this);
            }
        });

        startDateInput.addEventListener('keypress', function(e) {
            const char = String.fromCharCode(e.which || e.keyCode);
            if (!/\d/.test(char)) {
                e.preventDefault();
                return false;
            }
        });

        // Форматирование и валидация даты окончания
        endDateInput.addEventListener('input', function() {
            formatDateInput(this);
        });

        endDateInput.addEventListener('blur', function() {
            if (this.value.length === 10) {
                validateDate(this);

                // Проверка, что дата окончания не раньше даты начала
                const startValue = startDateInput.value;
                if (startValue && this.value) {
                    const [sDay, sMonth, sYear] = startValue.split('.');
                    const [eDay, eMonth, eYear] = this.value.split('.');

                    const startDate = new Date(sYear, sMonth - 1, sDay);
                    const endDate = new Date(eYear, eMonth - 1, eDay);

                    if (endDate < startDate) {
                        showFieldError(this, 'Дата окончания не может быть раньше даты начала');
                    }
                }
            }
        });

        endDateInput.addEventListener('keypress', function(e) {
            const char = String.fromCharCode(e.which || e.keyCode);
            if (!/\d/.test(char)) {
                e.preventDefault();
                return false;
            }
        });
    });
</script>
{% endblock %}