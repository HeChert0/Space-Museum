{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<a href="{% url 'entities_menu' %}" class="back-button">← Назад</a>

<h1 class="menu-title">{{ operation }} экскурсию</h1>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}" style="
            padding: 10px;
            margin-bottom: 20px;
            border: 2px solid {% if message.tags == 'error' %}#ff0000{% else %}#00ff00{% endif %};
            color: {% if message.tags == 'error' %}#ff0000{% else %}#00ff00{% endif %};
            background: rgba({% if message.tags == 'error' %}255,0,0{% else %}0,255,0{% endif %}, 0.1);
        ">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<form method="post" class="entity-form" id="excursionForm">
    {% csrf_token %}

    <div class="form-group">
        <label for="title">Название: <span class="required">*</span></label>
        <input type="text" name="title" id="title" required
               value="{{ fields_data.form_data.title|default:'' }}"
               {% if fields_data.error_field == 'title' %}class="error-field"{% endif %}
               placeholder="Название экскурсии" maxlength="50">
        <small>Только буквы, 2-50 символов</small>
    </div>

    <div class="form-group">
        <label for="date">Дата проведения: <span class="required">*</span></label>
        <input type="date" name="date" id="date" required
               min="2002-01-01" max="" class="date-calendar"
               readonly onfocus="this.removeAttribute('readonly')"
               onblur="this.setAttribute('readonly', true)">
        <div class="field-error" id="date_error"></div>
    </div>

    <div class="form-group">
        <label for="language">Язык: <span class="required">*</span></label>
        <select name="language" id="language" required
                {% if fields_data.error_field == 'language' %}class="error-field"{% endif %}>
            <option value="">-- Выберите язык --</option>
            {% for lang in fields_data.languages %}
            <option value="{{ lang }}" {% if lang == fields_data.form_data.language %}selected{% endif %}>
                {{ lang }}
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="ticket_num">Количество билетов: <span class="required">*</span></label>
        <input type="number" name="ticket_num" id="ticket_num" required
               value="{{ fields_data.form_data.ticket_num|default:'' }}"
               {% if fields_data.error_field == 'ticket_num' %}class="error-field"{% endif %}
               min="10" max="100" placeholder="10-100">
        <small>От 10 до 100 билетов</small>
    </div>

    <div class="form-group">
        <label for="price">Цена: <span class="required">*</span></label>
        <input type="number" name="price" id="price" required
               value="{{ fields_data.form_data.price|default:'' }}"
               {% if fields_data.error_field == 'price' %}class="error-field"{% endif %}
               min="20" max="300" step="0.01" placeholder="20-300">
        <small>От 20 до 300 рублей</small>
    </div>

    <div class="form-group">
        <label for="duration">Продолжительность (минуты): <span class="required">*</span></label>
        <input type="number" name="duration" id="duration" required
               value="{{ fields_data.form_data.duration|default:'' }}"
               {% if fields_data.error_field == 'duration' %}class="error-field"{% endif %}
               min="30" max="180" placeholder="30-180">
        <small>От 30 до 180 минут</small>
    </div>

    <div class="form-group">
        <label for="employee_id">Экскурсовод:</label>
        <select name="employee_id" id="employee_id"
                {% if fields_data.error_field == 'employee_id' %}class="error-field"{% endif %}>
            <option value="">-- Не назначен --</option>
            {% for guide in fields_data.tour_guides %}
            <option value="{{ guide.employee_id }}"
                    {% if guide.employee_id|stringformat:"s" == fields_data.form_data.employee_id %}selected{% endif %}>
                [ID: {{ guide.employee_id }}] {{ guide.full_name }} - {{ guide.position }}
            </option>
            {% endfor %}
        </select>
        <small>Выберите экскурсовода (необязательно)</small>
    </div>

    <button type="submit" class="btn-submit">{{ operation }}</button>
</form>

<style>
    .required { color: #ff0000; }
    .error-field {
        border-color: #ff0000 !important;
        box-shadow: 0 0 10px rgba(255, 0, 0, 0.5) !important;
    }
    small {
        display: block;
        margin-top: 5px;
        font-size: 12px;
        color: #00ff00;
        opacity: 0.8;
    }

    .date-calendar {
        cursor: pointer;
        background: #1a1a1a;
        color: #00ff00;
        border: 1px solid #00ff00;
        padding: 10px;
        font-family: 'Courier New', monospace;
        width: 100%;
        position: relative;
    }

    .date-calendar::-webkit-calendar-picker-indicator {
        filter: invert(1);
        cursor: pointer;
        position: absolute;
        right: 10px;
        width: 20px;
        height: 20px;
    }

    .date-calendar:hover {
        box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
    }

    .date-calendar[readonly] {
        cursor: pointer;
        background: #1a1a1a;
    }

    .date-calendar {
        caret-color: transparent;
    }

    .field-error {
        color: #ff0000;
        font-size: 12px;
        margin-top: 5px;
        display: none;
    }

    .field-error.show {
        display: block;
    }

    input.error {
        border-color: #ff0000 !important;
        box-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
    }

    input.valid {
        border-color: #00ff00 !important;
    }
</style>

<script src="{% static 'core/js/validation.js' %}"></script>
<script>
    // Функции для показа/скрытия ошибок
    function showFieldError(input, message) {
        const errorDiv = document.getElementById(input.id + '_error');
        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }
        input.classList.add('error');
        input.classList.remove('valid');
    }

    function clearFieldError(input) {
        const errorDiv = document.getElementById(input.id + '_error');
        if (errorDiv) {
            errorDiv.textContent = '';
            errorDiv.classList.remove('show');
        }
        input.classList.remove('error');
        input.classList.add('valid');
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Устанавливаем максимальную дату
        const today = new Date();
        const maxDate = new Date();
        maxDate.setMonth(maxDate.getMonth() + 6); // Можно планировать экскурсии на 6 месяцев вперед
        const maxDateStr = maxDate.toISOString().split('T')[0];

        // Валидация названия - как у выставок
        const titleInput = document.getElementById('title');
        restrictExhibitionTitleInput(titleInput);

        // Настройка календаря для даты проведения
        const dateInput = document.getElementById('date');

        if (dateInput) {
            dateInput.max = maxDateStr;

            // Блокируем ввод с клавиатуры
            dateInput.addEventListener('keydown', function(e) {
                if (e.key !== 'Tab') {
                    e.preventDefault();
                }
            });

            // Блокируем вставку
            dateInput.addEventListener('paste', function(e) {
                e.preventDefault();
            });

            // Валидация при изменении даты через календарь
            dateInput.addEventListener('change', function() {
                if (!this.value) {
                    showFieldError(this, 'Выберите дату проведения');
                    return;
                }

                const selectedDate = new Date(this.value);
                const minDate = new Date('2002-01-01');
                const todayDate = new Date();
                todayDate.setHours(0, 0, 0, 0);

                if (selectedDate < minDate) {
                    showFieldError(this, 'Музей открыт с 2002 года');
                    this.value = '';
                } else if (selectedDate > maxDate) {
                    showFieldError(this, 'Экскурсии можно планировать максимум на 6 месяцев вперед');
                    this.value = '';
                } else {
                    clearFieldError(this);
                }
            });
        }

        // Валидация количества билетов - только цифры
        const ticketNumInput = document.getElementById('ticket_num');
        restrictNumberInput(ticketNumInput, 10, 100);

        // Валидация цены - цифры и точка
        const priceInput = document.getElementById('price');
        restrictPriceInput(priceInput, 20, 300);

        // Валидация продолжительности - только цифры
        const durationInput = document.getElementById('duration');
        restrictNumberInput(durationInput, 30, 180);
    });
</script>
{% endblock %}