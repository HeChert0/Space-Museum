<!-- core/templates/core/visitor_form_add.html -->
{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<a href="{% url 'entities_menu' %}" class="back-button">← Назад</a>

<h1 class="menu-title">{{ operation }} посетителя</h1>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}" style="
            padding: 10px;
            margin-bottom: 20px;
            border: 2px solid {% if message.tags == 'error' %}#ff0000{% else %}#00ff00{% endif %};
            color: {% if message.tags == 'error' %}#ff0000{% else %}#00ff00{% endif %};
            background: rgba({% if message.tags == 'error' %}255,0,0{% else %}0,255,0{% endif %}, 0.1);
        ">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<form method="post" class="entity-form" id="visitorForm">
    {% csrf_token %}

    <div class="form-group">
        <label for="full_name">ФИО: <span class="required">*</span></label>
        <input type="text" name="full_name" id="full_name" required
               placeholder="Иванов Иван Иванович" maxlength="100">
        <!-- *** ИЗМЕНЕНО: обновлена подсказка и увеличен maxlength *** -->
        <small>Минимум имя и фамилия, только буквы и дефис</small>
        <div class="field-error" id="full_name_error"></div>
    </div>

    <div class="form-group">
        <label for="birth_date">Дата рождения: <span class="required">*</span></label>
        <input type="date" name="birth_date" id="birth_date" required
               min="1925-01-01" max="" class="date-calendar"
               readonly onfocus="this.removeAttribute('readonly')"
               onblur="this.setAttribute('readonly', true)">
        <div class="field-error" id="birth_date_error"></div>
    </div>

    <div class="form-group">
        <label for="citizenship">Гражданство: <span class="required">*</span></label>
        <select name="citizenship" id="citizenship" required>
            <option value="">-- Выберите страну --</option>
            {% for country in fields_data.countries %}
            <option value="{{ country }}">{{ country }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="ticket_type">Тип билета: <span class="required">*</span></label>
        <select name="ticket_type" id="ticket_type" required>
            <option value="">-- Выберите тип --</option>
            {% for ticket in fields_data.ticket_types %}
            <option value="{{ ticket }}">{{ ticket }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="visit_date">Дата посещения: <span class="required">*</span></label>
        <input type="date" name="visit_date" id="visit_date" required
               min="2002-01-01" max="" class="date-calendar"
               readonly onfocus="this.removeAttribute('readonly')"
               onblur="this.setAttribute('readonly', true)">
        <div class="field-error" id="visit_date_error"></div>
    </div>

    <div class="form-group">
        <label for="review">Отзыв:</label>
        <textarea name="review" id="review" maxlength="100"
                  placeholder="Ваш отзыв (необязательно, до 100 символов)"></textarea>
        <small>Осталось символов: <span id="reviewCharsLeft">100</span></small>
        <div class="field-error" id="review_error"></div>
    </div>

    <button type="submit" class="btn-submit">{{ operation }}</button>
</form>

<style>
    .required {
        color: #ff0000;
    }

    .field-error {
        color: #ff0000;
        font-size: 12px;
        margin-top: 5px;
        display: none;
    }

    .field-error.show {
        display: block;
    }

    input.error, select.error, textarea.error {
        border-color: #ff0000 !important;
        box-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
    }

    input.valid, select.valid, textarea.valid {
        border-color: #00ff00 !important;
    }

    small {
        display: block;
        margin-top: 5px;
        font-size: 12px;
        color: #00ff00;
        opacity: 0.8;
    }
    .date-calendar {
        cursor: pointer;
        background: #1a1a1a;
        color: #00ff00;
        border: 1px solid #00ff00;
        padding: 10px;
        font-family: 'Courier New', monospace;
    }

    .date-calendar::-webkit-calendar-picker-indicator {
        filter: invert(1);
        cursor: pointer;
    }

    .date-calendar:hover {
        box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
    }

</style>

<script src="{% static 'core/js/validation.js' %}"></script>
<script>
    // *** ДОБАВЛЕНО: Функции для отображения/скрытия ошибок *** //
    function showFieldError(input, message) {
        const errorDiv = document.getElementById(input.id + '_error');
        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }
        input.classList.add('error');
        input.classList.remove('valid');
    }

    function clearFieldError(input) {
        const errorDiv = document.getElementById(input.id + '_error');
        if (errorDiv) {
            errorDiv.textContent = '';
            errorDiv.classList.remove('show');
        }
        input.classList.remove('error');
        input.classList.add('valid');
    }

    // *** ДОБАВЛЕНО: Функция валидации дат *** //
    function validateDateField(input, fieldName) {
        const value = input.value.trim();

        if (!value) {
            showFieldError(input, fieldName + ' обязательна');
            return false;
        }

        // Проверка формата
        const datePattern = /^(\d{2})\.(\d{2})\.(\d{4})$/;
        const match = value.match(datePattern);

        if (!match) {
            showFieldError(input, 'Используйте формат ДД.ММ.ГГГГ');
            return false;
        }

        const day = parseInt(match[1]);
        const month = parseInt(match[2]);
        const year = parseInt(match[3]);

        // Проверка корректности даты
        const date = new Date(year, month - 1, day);
        if (date.getDate() !== day || date.getMonth() !== month - 1 || date.getFullYear() !== year) {
            showFieldError(input, 'Некорректная дата');
            return false;
        }

        clearFieldError(input);
        return true;
    }

document.addEventListener('DOMContentLoaded', function() {
    // Устанавливаем максимальную дату (сегодня) для календарей
    const today = new Date().toISOString().split('T')[0];

    // Функция для расчета возраста на определенную дату
    function calculateAge(birthDate, onDate) {
        const birth = new Date(birthDate);
        const checkDate = new Date(onDate);
        let age = checkDate.getFullYear() - birth.getFullYear();
        const monthDiff = checkDate.getMonth() - birth.getMonth();

        if (monthDiff < 0 || (monthDiff === 0 && checkDate.getDate() < birth.getDate())) {
            age--;
        }

        return age;
    }

    // Функция для обновления доступных типов билетов
    function updateTicketTypes() {
        const birthDateInput = document.getElementById('birth_date');
        const visitDateInput = document.getElementById('visit_date');
        const ticketTypeSelect = document.getElementById('ticket_type');

        if (!birthDateInput.value || !visitDateInput.value || !ticketTypeSelect) {
            return;
        }

        const age = calculateAge(birthDateInput.value, visitDateInput.value);
        const currentValue = ticketTypeSelect.value;

        // Очищаем список
        ticketTypeSelect.innerHTML = '<option value="">-- Выберите тип --</option>';

        // Добавляем доступные типы билетов на основе возраста
        if (age < 16) {
            // Только детский билет для детей до 16
            ticketTypeSelect.innerHTML += '<option value="Детский">Детский (до 16 лет)</option>';
        } else {
            // Взрослый билет доступен всем от 16 лет
            ticketTypeSelect.innerHTML += '<option value="Взрослый">Взрослый</option>';

            // Студенческий билет для возраста 16-30
            if (age >= 16 && age <= 30) {
                ticketTypeSelect.innerHTML += '<option value="Студенческий">Студенческий (16-30 лет)</option>';
            }

            // Пенсионный билет для 55+
            if (age >= 55) {
                ticketTypeSelect.innerHTML += '<option value="Пенсионный">Пенсионный (55+ лет)</option>';
            }
        }

        // Восстанавливаем предыдущее значение, если оно все еще доступно
        const options = Array.from(ticketTypeSelect.options).map(opt => opt.value);
        if (options.includes(currentValue)) {
            ticketTypeSelect.value = currentValue;
        } else {
            ticketTypeSelect.value = '';
        }

        // Показываем подсказку
        if (ticketTypeSelect.options.length === 2) { // Один пустой + один тип
            ticketTypeSelect.options[1].selected = true; // Автовыбор единственного доступного
            clearFieldError(ticketTypeSelect);
        }
    }

    // Применение валидации для ФИО
    const fioInput = document.getElementById('full_name');
    if (fioInput) {
        restrictFIOInput(fioInput);
        fioInput.addEventListener('input', function() {
            validateFIO(this);
        });
        fioInput.addEventListener('blur', function() {
            validateFIO(this);
        });
    }

    // Настройка календарей для дат
    const birthDateInput = document.getElementById('birth_date');
    const visitDateInput = document.getElementById('visit_date');
    const ticketTypeSelect = document.getElementById('ticket_type');

    if (birthDateInput) {
        birthDateInput.max = today;

        // Блокируем ввод с клавиатуры
        birthDateInput.addEventListener('keydown', function(e) {
            if (e.key !== 'Tab') {
                e.preventDefault();
            }
        });

        birthDateInput.addEventListener('paste', function(e) {
            e.preventDefault();
        });

        // Валидация при изменении даты рождения
        birthDateInput.addEventListener('change', function() {
            if (!this.value) {
                showFieldError(this, 'Выберите дату рождения');
                return;
            }

            const selectedDate = new Date(this.value);
            const minDate = new Date('1925-01-01');
            const maxDate = new Date();

            // Проверка минимального возраста (6 лет)
            const age = calculateAge(this.value, today);
            if (age < 6) {
                showFieldError(this, 'Посетитель должен быть старше 6 лет');
                this.value = '';
                return;
            }

            if (selectedDate < minDate) {
                showFieldError(this, 'Дата не может быть раньше 1925 года');
                this.value = '';
            } else if (selectedDate > maxDate) {
                showFieldError(this, 'Дата не может быть в будущем');
                this.value = '';
            } else {
                clearFieldError(this);

                // Обновляем минимальную дату посещения
                if (visitDateInput) {
                    // Дата посещения не может быть раньше даты рождения
                    visitDateInput.min = this.value;

                    // Если дата посещения уже выбрана и она раньше даты рождения
                    if (visitDateInput.value && new Date(visitDateInput.value) < new Date(this.value)) {
                        visitDateInput.value = '';
                        showFieldError(visitDateInput, 'Дата посещения не может быть раньше даты рождения');
                    }

                    // Обновляем типы билетов
                    updateTicketTypes();
                }
            }
        });
    }

    if (visitDateInput) {
        visitDateInput.max = today;
        visitDateInput.min = '2002-01-01'; // Начальное значение

        // Блокируем выбор даты посещения до выбора даты рождения
        visitDateInput.addEventListener('focus', function() {
            if (!birthDateInput.value) {
                this.blur();
                showFieldError(birthDateInput, 'Сначала выберите дату рождения');
                showFieldError(this, 'Выберите дату рождения');
            }
        });

        visitDateInput.addEventListener('keydown', function(e) {
            if (e.key !== 'Tab') {
                e.preventDefault();
            }
        });

        visitDateInput.addEventListener('paste', function(e) {
            e.preventDefault();
        });

        // Валидация при изменении даты посещения
        visitDateInput.addEventListener('change', function() {
            if (!this.value) {
                showFieldError(this, 'Выберите дату посещения');
                return;
            }

            if (!birthDateInput.value) {
                showFieldError(this, 'Сначала выберите дату рождения');
                this.value = '';
                return;
            }

            const selectedDate = new Date(this.value);
            const birthDate = new Date(birthDateInput.value);
            const minDate = new Date('2002-01-01');
            const maxDate = new Date();

            // Проверка, что дата посещения не раньше даты рождения
            if (selectedDate < birthDate) {
                showFieldError(this, 'Дата посещения не может быть раньше даты рождения');
                this.value = '';
                return;
            }

            // Проверка возраста на момент посещения
            const ageAtVisit = calculateAge(birthDateInput.value, this.value);
            if (ageAtVisit < 6) {
                showFieldError(this, 'На момент посещения посетителю должно быть минимум 6 лет');
                this.value = '';
                return;
            }

            if (selectedDate < minDate) {
                showFieldError(this, 'Музей открыт с 2002 года');
                this.value = '';
            } else if (selectedDate > maxDate) {
                showFieldError(this, 'Дата не может быть в будущем');
                this.value = '';
            } else {
                clearFieldError(this);
                // Обновляем типы билетов
                updateTicketTypes();
            }
        });
    }

    // Блокируем выбор типа билета до выбора дат
    if (ticketTypeSelect) {
        ticketTypeSelect.addEventListener('focus', function() {
            if (!birthDateInput.value || !visitDateInput.value) {
                this.blur();
                if (!birthDateInput.value) {
                    showFieldError(birthDateInput, 'Сначала выберите дату рождения');
                }
                if (!visitDateInput.value) {
                    showFieldError(visitDateInput, 'Сначала выберите дату посещения');
                }
                showFieldError(this, 'Выберите даты для определения доступных типов билетов');
            }
        });
    }

    // Валидация отзыва
    const reviewInput = document.getElementById('review');
    if (reviewInput) {
        reviewInput.addEventListener('input', function() {
            const value = this.value.trim();
            const left = 100 - this.value.length;
            document.getElementById('reviewCharsLeft').textContent = left;

            if (value && value.length < 5) {
                showFieldError(this, 'Отзыв слишком короткий (минимум 5 символов)');
            } else if (value && /^[!@#$%^&*()_+=\-\s]+$/.test(value)) {
                showFieldError(this, 'Отзыв не может состоять только из специальных символов');
            } else {
                clearFieldError(this);
            }
        });
    }

    // Валидация формы перед отправкой
    const form = document.getElementById('visitorForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            let isValid = true;

            // Проверяем ФИО
            if (fioInput) {
                validateFIO(fioInput);
                if (fioInput.classList.contains('error')) {
                    isValid = false;
                }
            }

            // Проверяем даты
            if (birthDateInput && !birthDateInput.value) {
                showFieldError(birthDateInput, 'Выберите дату рождения');
                isValid = false;
            }

            if (visitDateInput && !visitDateInput.value) {
                showFieldError(visitDateInput, 'Выберите дату посещения');
                isValid = false;
            }

            // Проверяем возраст еще раз
            if (birthDateInput && birthDateInput.value && visitDateInput && visitDateInput.value) {
                const ageAtVisit = calculateAge(birthDateInput.value, visitDateInput.value);
                if (ageAtVisit < 6) {
                    showFieldError(birthDateInput, 'Посетитель слишком молод');
                    isValid = false;
                }
            }

            // Проверяем гражданство
            const citizenshipSelect = document.getElementById('citizenship');
            if (citizenshipSelect && !citizenshipSelect.value) {
                showFieldError(citizenshipSelect, 'Выберите гражданство');
                isValid = false;
            } else if (citizenshipSelect) {
                clearFieldError(citizenshipSelect);
            }

            // Проверяем тип билета
            if (ticketTypeSelect && !ticketTypeSelect.value) {
                showFieldError(ticketTypeSelect, 'Выберите тип билета');
                isValid = false;
            } else if (ticketTypeSelect) {
                clearFieldError(ticketTypeSelect);
            }

            if (!isValid) {
                e.preventDefault();
                alert('Пожалуйста, исправьте ошибки в форме');
            }
        });
    }
});
</script>
{% endblock %}