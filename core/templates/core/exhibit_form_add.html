<!-- core/templates/core/exhibit_form_add.html -->
{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<a href="{% url 'entities_menu' %}" class="back-button">← Назад</a>

<h1 class="menu-title">{{ operation }} экспонат</h1>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}" style="
            padding: 10px;
            margin-bottom: 20px;
            border: 2px solid {% if message.tags == 'error' %}#ff0000{% else %}#00ff00{% endif %};
            color: {% if message.tags == 'error' %}#ff0000{% else %}#00ff00{% endif %};
            background: rgba({% if message.tags == 'error' %}255,0,0{% else %}0,255,0{% endif %}, 0.1);
        ">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<form method="post" class="entity-form" id="exhibitForm">
    {% csrf_token %}

    <div class="form-group">
        <label for="title">Название: <span class="required">*</span></label>
        <input type="text" name="title" id="title" required
               value="{{ fields_data.form_data.title|default:'' }}"
               {% if fields_data.error_field == 'title' %}class="error-field"{% endif %}
               placeholder="Название экспоната" maxlength="50">
        <small>Буквы, цифры, кавычки, 2-50 символов</small>
    </div>

    <div class="form-group">
        <label for="description">Описание: <span class="required">*</span></label>
        <textarea name="description" id="description" required
                  {% if fields_data.error_field == 'description' %}class="error-field"{% endif %}
                  placeholder="Описание экспоната" maxlength="100">{{ fields_data.form_data.description|default:'' }}</textarea>
        <small>Буквы, цифры, пунктуация, 5-100 символов</small>
    </div>

    <div class="form-group">
        <label for="creation_date">Дата создания: <span class="required">*</span></label>
        <input type="text" name="creation_date" id="creation_date" required
               value="{{ fields_data.form_data.creation_date|default:'' }}"
               {% if fields_data.error_field == 'creation_date' %}class="error-field date-input"{% else %}class="date-input"{% endif %}
               placeholder="ДД.ММ.ГГГГ" maxlength="10">
        <small>Дата не может быть в будущем</small>
    </div>

    <div class="form-group">
        <label for="country">Страна: <span class="required">*</span></label>
        <select name="country" id="country" required
                {% if fields_data.error_field == 'country' %}class="error-field"{% endif %}>
            <option value="">-- Выберите страну --</option>
            {% for country in fields_data.countries %}
            <option value="{{ country }}" {% if country == fields_data.form_data.country %}selected{% endif %}>
                {{ country }}
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="state">Состояние: <span class="required">*</span></label>
        <select name="state" id="state" required
                {% if fields_data.error_field == 'state' %}class="error-field"{% endif %}>
            <option value="">-- Выберите состояние --</option>
            {% for state in fields_data.states %}
            <option value="{{ state }}" {% if state == fields_data.form_data.state %}selected{% endif %}>
                {{ state }}
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="type">Тип: <span class="required">*</span></label>
        <select name="type" id="type" required
                {% if fields_data.error_field == 'type' %}class="error-field"{% endif %}>
            <option value="">-- Выберите тип --</option>
            {% for type in fields_data.types %}
            <option value="{{ type }}" {% if type == fields_data.form_data.type %}selected{% endif %}>
                {{ type }}
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="mission_id">Миссия:</label>
        <select name="mission_id" id="mission_id"
                {% if fields_data.error_field == 'mission_id' %}class="error-field"{% endif %}>
            <option value="">-- Не указана --</option>
            {% for mission in fields_data.missions %}
            <option value="{{ mission.mission_id }}"
                    {% if mission.mission_id|stringformat:"s" == fields_data.form_data.mission_id %}selected{% endif %}>
                [ID: {{ mission.mission_id }}] {{ mission.title }}
            </option>
            {% endfor %}
        </select>
        <small>Выберите миссию (необязательно)</small>
    </div>

    <button type="submit" class="btn-submit">{{ operation }}</button>
</form>

<style>
    .required { color: #ff0000; }
    .error-field {
        border-color: #ff0000 !important;
        box-shadow: 0 0 10px rgba(255, 0, 0, 0.5) !important;
    }
    small { display: block; margin-top: 5px; font-size: 12px; color: #00ff00; opacity: 0.8; }
</style>

<script src="{% static 'core/js/validation.js' %}"></script>
<script>
    // Валидация названия (с цифрами и кавычками)
    document.getElementById('title').addEventListener('input', function() {
        const value = this.value.trim();
        if (value.length < 2) {
            showFieldError(this, 'Минимум 2 символа');
        } else if (value.length > 50) {
            showFieldError(this, 'Максимум 50 символов');
        } else if (!/^[а-яА-ЯёЁa-zA-Z0-9\s\(\)\"\-]+$/.test(value)) {
            showFieldError(this, 'Недопустимые символы');
        } else {
            clearFieldError(this);
        }
    });

    // Валидация описания
    document.getElementById('description').addEventListener('input', function() {
        const value = this.value.trim();
        if (value.length < 5) {
            showFieldError(this, 'Минимум 5 символов');
        } else if (value.length > 100) {
            showFieldError(this, 'Максимум 100 символов');
        } else {
            clearFieldError(this);
        }
    });

    // Валидация даты - не в будущем
    document.getElementById('creation_date').addEventListener('blur', function() {
        if (this.value.length === 10) {
            if (validateDate(this)) {
                const [day, month, year] = this.value.split('.');
                const inputDate = new Date(year, month - 1, day);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                if (inputDate > today) {
                    showFieldError(this, 'Дата не может быть в будущем');
                }
            }
        }
    });
</script>
{% endblock %}