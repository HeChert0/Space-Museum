{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<a href="{% url 'entities_menu' %}" class="back-button">← Назад</a>

<h1 class="menu-title">{{ operation }} экспонат</h1>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}" style="
            padding: 10px;
            margin-bottom: 20px;
            border: 2px solid {% if message.tags == 'error' %}#ff0000{% else %}#00ff00{% endif %};
            color: {% if message.tags == 'error' %}#ff0000{% else %}#00ff00{% endif %};
            background: rgba({% if message.tags == 'error' %}255,0,0{% else %}0,255,0{% endif %}, 0.1);
        ">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<form method="post" class="entity-form" id="exhibitForm">
    {% csrf_token %}

    <div class="form-group">
        <label for="title">Название: <span class="required">*</span></label>
        <input type="text" name="title" id="title" required
               value="{{ fields_data.form_data.title|default:'' }}"
               {% if fields_data.error_field == 'title' %}class="error-field"{% endif %}
               placeholder="Название экспоната" maxlength="50">
        <small>Буквы, цифры, кавычки, 2-50 символов</small>
    </div>

    <div class="form-group">
        <label for="description">Описание: <span class="required">*</span></label>
        <textarea name="description" id="description" required
                  {% if fields_data.error_field == 'description' %}class="error-field"{% endif %}
                  placeholder="Описание экспоната" maxlength="500">{{ fields_data.form_data.description|default:'' }}</textarea>
        <small>Буквы, цифры, пунктуация, 5-500 символов</small>
        <div class="field-error" id="description_error"></div>
    </div>

    <div class="form-group">
        <label for="creation_date">Дата создания: <span class="required">*</span></label>
        <input type="date" name="creation_date" id="creation_date" required
               min="1950-01-01" max="" class="date-calendar"
               readonly onfocus="this.removeAttribute('readonly')"
               onblur="this.setAttribute('readonly', true)">
        <div class="field-error" id="creation_date_error"></div>
        <small>Экспонаты космической эры (с 1950 года)</small>
    </div>

    <div class="form-group">
        <label for="country">Страна: <span class="required">*</span></label>
        <select name="country" id="country" required
                {% if fields_data.error_field == 'country' %}class="error-field"{% endif %}>
            <option value="">-- Выберите страну --</option>
            {% for country in fields_data.countries %}
            <option value="{{ country }}" {% if country == fields_data.form_data.country %}selected{% endif %}>
                {{ country }}
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="state">Состояние: <span class="required">*</span></label>
        <select name="state" id="state" required
                {% if fields_data.error_field == 'state' %}class="error-field"{% endif %}>
            <option value="">-- Выберите состояние --</option>
            {% for state in fields_data.states %}
            <option value="{{ state }}" {% if state == fields_data.form_data.state %}selected{% endif %}>
                {{ state }}
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="type">Тип: <span class="required">*</span></label>
        <select name="type" id="type" required
                {% if fields_data.error_field == 'type' %}class="error-field"{% endif %}>
            <option value="">-- Выберите тип --</option>
            {% for type in fields_data.types %}
            <option value="{{ type }}" {% if type == fields_data.form_data.type %}selected{% endif %}>
                {{ type }}
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="mission_id">Миссия:</label>
        <select name="mission_id" id="mission_id"
                {% if fields_data.error_field == 'mission_id' %}class="error-field"{% endif %}>
            <option value="">-- Не указана --</option>
            {% for mission in fields_data.missions %}
            <option value="{{ mission.mission_id }}"
                    {% if mission.mission_id|stringformat:"s" == fields_data.form_data.mission_id %}selected{% endif %}>
                [ID: {{ mission.mission_id }}] {{ mission.title }}
            </option>
            {% endfor %}
        </select>
        <small>Выберите миссию (необязательно)</small>
    </div>

    <button type="submit" class="btn-submit">{{ operation }}</button>
</form>

<style>
    .required { color: #ff0000; }
    .error-field {
        border-color: #ff0000 !important;
        box-shadow: 0 0 10px rgba(255, 0, 0, 0.5) !important;
    }
    small {
        display: block;
        margin-top: 5px;
        font-size: 12px;
        color: #00ff00;
        opacity: 0.8;
    }

    .date-calendar {
        cursor: pointer;
        background: #1a1a1a;
        color: #00ff00;
        border: 1px solid #00ff00;
        padding: 10px;
        font-family: 'Courier New', monospace;
        width: 100%;
        position: relative;
    }

    .date-calendar::-webkit-calendar-picker-indicator {
        filter: invert(1);
        cursor: pointer;
        position: absolute;
        right: 10px;
        width: 20px;
        height: 20px;
    }

    .date-calendar:hover {
        box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
    }

    .date-calendar[readonly] {
        cursor: pointer;
        background: #1a1a1a;
    }

    .date-calendar {
        caret-color: transparent;
    }

    .field-error {
        color: #ff0000;
        font-size: 12px;
        margin-top: 5px;
        display: none;
    }

    .field-error.show {
        display: block;
    }

    input.error, textarea.error {
        border-color: #ff0000 !important;
        box-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
    }

    input.valid, textarea.valid {
        border-color: #00ff00 !important;
    }

    textarea {
        width: 100%;
        min-height: 100px;
        background: #1a1a1a;
        color: #00ff00;
        border: 1px solid #00ff00;
        padding: 10px;
        font-family: 'Courier New', monospace;
        resize: vertical;
    }
</style>

<script src="{% static 'core/js/validation.js' %}"></script>
<script>
    // Функции для показа/скрытия ошибок
    function showFieldError(input, message) {
        const errorDiv = document.getElementById(input.id + '_error');
        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }
        input.classList.add('error');
        input.classList.remove('valid');
    }

    function clearFieldError(input) {
        const errorDiv = document.getElementById(input.id + '_error');
        if (errorDiv) {
            errorDiv.textContent = '';
            errorDiv.classList.remove('show');
        }
        input.classList.remove('error');
        input.classList.add('valid');
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Устанавливаем максимальную дату (сегодня)
        const today = new Date().toISOString().split('T')[0];

        // Валидация названия - как у выставок
        const titleInput = document.getElementById('title');
        restrictExhibitionTitleInput(titleInput);

        // Валидация описания с увеличенным лимитом
        const descriptionInput = document.getElementById('description');

        descriptionInput.addEventListener('input', function() {
            const value = this.value.trim();
            if (value.length < 5) {
                showFieldError(this, 'Минимум 5 символов');
            } else if (value.length > 500) {
                showFieldError(this, 'Максимум 500 символов');
                this.value = this.value.substring(0, 500);
            } else {
                clearFieldError(this);
            }
        });

        // Настройка календаря для даты создания
        const creationDateInput = document.getElementById('creation_date');

        if (creationDateInput) {
            creationDateInput.max = today;

            // Блокируем ввод с клавиатуры
            creationDateInput.addEventListener('keydown', function(e) {
                if (e.key !== 'Tab') {
                    e.preventDefault();
                }
            });

            // Блокируем вставку
            creationDateInput.addEventListener('paste', function(e) {
                e.preventDefault();
            });

            // Валидация при изменении даты через календарь
            creationDateInput.addEventListener('change', function() {
                if (!this.value) {
                    showFieldError(this, 'Выберите дату создания экспоната');
                    return;
                }

                const selectedDate = new Date(this.value);
                const minDate = new Date('1950-01-01');
                const maxDate = new Date();

                if (selectedDate < minDate) {
                    showFieldError(this, 'Космическая эра началась с 1950 года');
                    this.value = '';
                } else if (selectedDate > maxDate) {
                    showFieldError(this, 'Дата не может быть в будущем');
                    this.value = '';
                } else {
                    clearFieldError(this);

                    // Показываем эпоху экспоната
                    const year = selectedDate.getFullYear();
                    let era = '';
                    if (year >= 1950 && year < 1960) {
                        era = 'Начало космической эры';
                    } else if (year >= 1960 && year < 1970) {
                        era = 'Золотой век космонавтики';
                    } else if (year >= 1970 && year < 1990) {
                        era = 'Эра космических станций';
                    } else if (year >= 1990 && year < 2000) {
                        era = 'Международное сотрудничество';
                    } else if (year >= 2000) {
                        era = 'Современная космонавтика';
                    }

                    if (era) {
                        const small = this.parentElement.querySelector('small');
                        if (small) {
                            small.textContent = era;
                        }
                    }
                }
            });
        }
    });
</script>
{% endblock %}