<!-- core/templates/core/universal_crud_operation.html -->
{% extends 'core/base.html' %}
{% load custom_filters %}

{% block content %}
<a href="{% url 'universal_crud' %}" class="back-button">‚Üê –ù–∞–∑–∞–¥</a>

<h1 class="menu-title">
    {% if operation == 'view' %}üìã –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–∞–±–ª–∏—Ü—ã: {{ table_name }}
    {% elif operation == 'add' %}‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤: {{ table_name }}
    {% elif operation == 'update' %}‚úèÔ∏è –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤: {{ table_name }}
    {% elif operation == 'delete' %}‚ùå –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∏–∑: {{ table_name }}
    {% endif %}
</h1>

{% if operation == 'view' %}
    <!-- –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö -->
    <div class="table-container">
        <div class="filter-section">
            <form method="get" class="filter-form">
                <input type="hidden" name="table" value="{{ table_name }}">
                <input type="hidden" name="operation" value="view">
                <select name="filter_column">
                    <option value="">-- –§–∏–ª—å—Ç—Ä –ø–æ –∫–æ–ª–æ–Ω–∫–µ --</option>
                    {% for col in columns %}
                    <option value="{{ col.name }}" {% if col.name == filter_column %}selected{% endif %}>{{ col.name }}</option>
                    {% endfor %}
                </select>
                <input type="text" name="filter_value" value="{{ filter_value }}" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞">
                <button type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
                {% if filter_column %}
                <a href="?table={{ table_name }}&operation=view" class="btn-clear">–û—á–∏—Å—Ç–∏—Ç—å</a>
                {% endif %}
            </form>
        </div>

        <table>
            <thead>
                <tr>
                    {% for col in columns %}
                    <th>{{ col.name }}</th>
                    {% endfor %}
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for row in data %}
                <tr>
                    {% for value in row.values %}
                    <td>
                        {% if value.type == 'date' %}
                            {{ value.value|format_date|default:"-" }}
                        {% else %}
                            {{ value.value|format_array|default:"-" }}
                        {% endif %}
                    </td>
                    {% endfor %}
                    <td>
                        <a href="?table={{ table_name }}&operation=update&id={{ row.id }}" class="btn-action btn-edit">‚úèÔ∏è</a>
                        <form method="post" style="display: inline;" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="delete">
                            <input type="hidden" name="record_id" value="{{ row.id }}">
                            <button type="submit" class="btn-action btn-delete">‚ùå</button>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="{{ columns|length|add:1 }}" style="text-align: center;">
                        –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

{% elif operation == 'add' %}
    <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ -->
    <form method="post" class="entity-form">
        {% csrf_token %}
        <input type="hidden" name="action" value="add">

        {% for field in fields %}
        <div class="form-group">
            <label for="{{ field.name }}">
                {{ field.name }}
                {% if field.type %}({{ field.type }}){% endif %}
                {% if not field.nullable %}<span style="color: red;">*</span>{% endif %}
                {% if field.is_pk and field.auto_increment %}<span style="color: #00ff00;"> (–∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è)</span>{% endif %}
            </label>

            {% if field.is_pk and field.auto_increment %}
                <input type="number" name="{{ field.name }}"
                       placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ">
                <small>ID –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –µ—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ–ª–µ –ø—É—Å—Ç—ã–º</small>
            {% elif field.type|is_array_field %}
                <input type="text" name="{{ field.name }}"
                       placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä: –∑–Ω–∞—á–µ–Ω–∏–µ1, –∑–Ω–∞—á–µ–Ω–∏–µ2, –∑–Ω–∞—á–µ–Ω–∏–µ3)"
                       {% if not field.nullable %}required{% endif %}>
                <small>–î–ª—è –º–∞—Å—Å–∏–≤–æ–≤: –≤–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é</small>
            {% elif field.type == 'text' or field.type == 'character varying' %}
                <textarea name="{{ field.name }}" {% if not field.nullable %}required{% endif %}></textarea>
            {% elif field.type == 'integer' or field.type == 'bigint' %}
                <input type="number" name="{{ field.name }}" {% if not field.nullable %}required{% endif %}>
            {% elif field.type == 'date' %}
                <input type="date" name="{{ field.name }}"
                       class="date-input"
                       {% if not field.nullable %}required{% endif %}>
                <small>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì</small>
            {% elif field.type == 'boolean' %}
                <select name="{{ field.name }}" {% if not field.nullable %}required{% endif %}>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                    <option value="true">–î–∞</option>
                    <option value="false">–ù–µ—Ç</option>
                </select>
            {% else %}
                <input type="text" name="{{ field.name }}" {% if not field.nullable %}required{% endif %}>
            {% endif %}
        </div>
        {% endfor %}

        <button type="submit" class="btn-submit">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
    </form>

{% elif operation == 'update' %}
    <!-- –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ -->
    {% if record %}
    <form method="post" class="entity-form">
        {% csrf_token %}
        <input type="hidden" name="action" value="update">
        <input type="hidden" name="record_id" value="{{ record_id }}">

        {% for field in fields %}
        <div class="form-group">
            <label for="{{ field.name }}">
                {{ field.name }}
                {% if field.type %}({{ field.type }}){% endif %}
                {% if not field.nullable %}<span style="color: red;">*</span>{% endif %}
            </label>

            {% if field.type|is_array_field %}
                <input type="text" name="{{ field.name }}"
                       value="{{ field.value|format_for_input:field.type }}"
                       placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä: –∑–Ω–∞—á–µ–Ω–∏–µ1, –∑–Ω–∞—á–µ–Ω–∏–µ2, –∑–Ω–∞—á–µ–Ω–∏–µ3)"
                       {% if not field.nullable %}required{% endif %}>
                <small>–î–ª—è –º–∞—Å—Å–∏–≤–æ–≤: –≤–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é</small>
            {% elif field.type == 'text' or field.type == 'character varying' %}
                <textarea name="{{ field.name }}" {% if not field.nullable %}required{% endif %}>{{ field.value|default:"" }}</textarea>
            {% elif field.type == 'integer' or field.type == 'bigint' %}
                <input type="number" name="{{ field.name }}" value="{{ field.value|default:"" }}" {% if not field.nullable %}required{% endif %}>
            {% elif field.type == 'date' %}
                <input type="date" name="{{ field.name }}"
                       value="{{ field.value|format_for_input:'date' }}"
                       class="date-input"
                       {% if not field.nullable %}required{% endif %}>
                <small>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì</small>
            {% elif field.type == 'boolean' %}
                <select name="{{ field.name }}" {% if not field.nullable %}required{% endif %}>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                    <option value="true" {% if field.value %}selected{% endif %}>–î–∞</option>
                    <option value="false" {% if not field.value %}selected{% endif %}>–ù–µ—Ç</option>
                </select>
            {% else %}
                <input type="text" name="{{ field.name }}" value="{{ field.value|default:"" }}" {% if not field.nullable %}required{% endif %}>
            {% endif %}
        </div>
        {% endfor %}

        <button type="submit" class="btn-submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
    </form>
    {% else %}
        <p>–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</p>
    {% endif %}

{% elif operation == 'delete' %}
    <!-- –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ -->
    <div class="table-container">
        <p style="color: #ffff00; margin-bottom: 20px;">
            ‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:
        </p>

        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="delete_multiple">

            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" onclick="toggleAll(this)"></th>
                        {% for col in columns %}
                        <th>{{ col.name }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in data %}
                    <tr>
                        <td><input type="checkbox" name="delete_ids" value="{{ row.id }}"></td>
                        {% for value in row.values %}
                        <td>
                            {% if value.type == 'date' %}
                                {{ value.value|format_date|default:"-" }}
                            {% else %}
                                {{ value.value|format_array|default:"-" }}
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="{{ columns|length|add:1 }}">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <button type="submit" class="btn-submit" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏?')">
                –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
            </button>
        </form>
    </div>
{% endif %}

{% if messages %}
    {% for message in messages %}
        <div class="message-box {{ message.tags }}">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<style>
    .filter-section {
        margin-bottom: 20px;
        padding: 15px;
        background-color: #001100;
        border: 1px solid #00ff00;
        border-radius: 5px;
    }

    .filter-form {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    .filter-form select, .filter-form input {
        padding: 8px 12px;
        background-color: #000000;
        border: 1px solid #00ff00;
        color: #00ff00;
        font-family: 'Courier New', monospace;
    }

    .filter-form button {
        padding: 8px 20px;
        background-color: #001100;
        border: 2px solid #00ff00;
        color: #00ff00;
        cursor: pointer;
        font-family: 'Courier New', monospace;
        transition: all 0.3s;
    }

    .filter-form button:hover {
        background-color: #00ff00;
        color: #000000;
    }

    .btn-action {
        padding: 5px 10px;
        margin: 0 2px;
        text-decoration: none;
        border-radius: 3px;
        display: inline-block;
        border: none;
        cursor: pointer;
        font-size: 14px;
    }

    .btn-edit {
        background-color: #0066ff;
        color: white;
    }

    .btn-delete {
        background-color: #ff0000;
        color: white;
    }

    .btn-edit:hover {
        background-color: #0099ff;
    }

    .btn-delete:hover {
        background-color: #cc0000;
    }

    .btn-clear {
        padding: 8px 15px;
        background-color: #ff6600;
        color: white;
        text-decoration: none;
        border-radius: 3px;
        transition: all 0.3s;
    }

    .btn-clear:hover {
        background-color: #ff8800;
    }

    .message-box {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #00ff00;
        background-color: #001100;
        color: #00ff00;
    }

    .message-box.error {
        border-color: #ff0000;
        color: #ff0000;
        background-color: #220000;
    }

    .message-box.success {
        border-color: #00ff00;
        color: #00ff00;
    }

    .form-group small {
        display: block;
        margin-top: 5px;
        font-size: 12px;
        color: #00ff00;
        opacity: 0.8;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–µ–π –¥–∞—Ç—ã */
    .date-input {
        position: relative;
        background-color: #000000;
        border: 1px solid #00ff00;
        color: #00ff00;
        padding: 10px;
        font-family: 'Courier New', monospace;
        width: 100%;
    }

    .date-input::-webkit-calendar-picker-indicator {
        filter: invert(1) hue-rotate(90deg) brightness(0.5) sepia(1) saturate(5);
        cursor: pointer;
        opacity: 1;
    }

    .date-input::-webkit-calendar-picker-indicator:hover {
        opacity: 0.8;
    }

    /* –î–ª—è Firefox */
    .date-input::-moz-calendar-picker-indicator {
        filter: invert(1) hue-rotate(90deg) brightness(0.5) sepia(1) saturate(5);
        cursor: pointer;
    }

    .date-input:focus {
        outline: none;
        border-color: #00ff00;
        box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
    }
</style>

<script>
    function toggleAll(source) {
        checkboxes = document.getElementsByName('delete_ids');
        for(var i=0; i<checkboxes.length; i++) {
            checkboxes[i].checked = source.checked;
        }
    }
</script>
{% endblock %}