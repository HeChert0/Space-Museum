<!-- core/templates/core/mission_form_update.html -->
{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<a href="{% url 'mission_update' %}" class="back-button">← Назад</a>

<h1 class="menu-title">{{ operation }} {{ entity_name }}</h1>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}" style="
            padding: 10px;
            margin-bottom: 20px;
            border: 2px solid {% if message.tags == 'error' %}#ff0000{% else %}#00ff00{% endif %};
            color: {% if message.tags == 'error' %}#ff0000{% else %}#00ff00{% endif %};
            background: rgba({% if message.tags == 'error' %}255,0,0{% else %}0,255,0{% endif %}, 0.1);
        ">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<form method="post" class="entity-form" id="missionForm">
    {% csrf_token %}

    <div class="form-group">
        <label for="title">Название: <span class="required">*</span></label>
        <input type="text" name="title" id="title" required
               value="{{ fields_data.mission.title }}"
               placeholder="Название миссии" maxlength="50">
        <small>Буквы, цифры, дефис, скобки, 2-50 символов</small>
    </div>

    <div class="form-group">
        <label>Страны: <span class="required">*</span></label>
        <div class="countries-container">
            {% for country in fields_data.countries %}
            <label class="checkbox-label">
                <input type="checkbox" name="countries[]" value="{{ country }}"
                       {% if country in fields_data.selected_countries %}checked{% endif %}>
                {{ country }}
            </label>
            {% endfor %}
        </div>
        <small>Выберите от 1 до 5 стран</small>
    </div>

    <div class="form-group">
        <label for="start_date">Дата начала: <span class="required">*</span></label>
        <input type="text" name="start_date" id="start_date" required
               value="{{ fields_data.mission.start_date|date:'d.m.Y' }}"
               class="date-input" placeholder="ДД.ММ.ГГГГ" maxlength="10">
    </div>

    <div class="form-group">
        <label for="end_date">Дата окончания:</label>
        <input type="text" name="end_date" id="end_date"
               value="{% if fields_data.mission.end_date %}{{ fields_data.mission.end_date|date:'d.m.Y' }}{% endif %}"
               class="date-input" placeholder="ДД.ММ.ГГГГ (необязательно)" maxlength="10">
        <small>Дата окончания должна быть позже даты начала</small>
    </div>

    <div class="form-group">
        <label>Экипаж:</label>
        <div id="crew-container">
            {% for member in fields_data.crew_members %}
            <div class="crew-member-row" style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="text" name="crew[]" value="{{ member }}"
                       placeholder="ФИО члена экипажа" class="crew-input">
                <button type="button" onclick="removeCrewMember(this)" class="btn-remove-crew">❌</button>
            </div>
            {% empty %}
            <div class="crew-member-row" style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="text" name="crew[]" placeholder="ФИО члена экипажа" class="crew-input">
                <button type="button" onclick="removeCrewMember(this)" class="btn-remove-crew">❌</button>
            </div>
            {% endfor %}
        </div>
        <button type="button" onclick="addCrewMember()" class="btn-add-crew">➕ Добавить члена экипажа</button>
        <small>Введите ФИО членов экипажа (необязательно)</small>
    </div>

    <div class="form-group">
        <label for="goal">Цель миссии: <span class="required">*</span></label>
        <textarea name="goal" id="goal" required
                  placeholder="Опишите цель миссии" maxlength="100">{{ fields_data.mission.goal }}</textarea>
        <small>От 10 до 100 символов</small>
    </div>

    <button type="submit" class="btn-submit">{{ operation }}</button>
</form>

<style>
    .required { color: #ff0000; }
    .countries-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-top: 10px;
        padding: 15px;
        border: 1px solid #00ff00;
        background-color: rgba(0, 255, 0, 0.05);
    }
    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
    }
    .checkbox-label input[type="checkbox"] {
        width: auto;
        margin: 0;
    }
    .btn-remove-crew {
        background: #001100;
        border: 1px solid #ff0000;
        color: #ff0000;
        padding: 5px 10px;
        cursor: pointer;
        transition: all 0.3s;
    }
    .btn-remove-crew:hover {
        background: #ff0000;
        color: #000000;
    }
    .btn-add-crew {
        background: #001100;
        border: 1px solid #00ff00;
        color: #00ff00;
        padding: 8px 15px;
        cursor: pointer;
        margin-top: 10px;
        transition: all 0.3s;
    }
    .btn-add-crew:hover {
        background: #00ff00;
        color: #000000;
    }
    small { display: block; margin-top: 5px; font-size: 12px; color: #00ff00; opacity: 0.8; }
</style>

<script src="{% static 'core/js/validation.js' %}"></script>
<script>
    document.getElementById('title').addEventListener('input', function() {
        validateTitleWithNumbers(this, 50);
    });

    document.getElementById('goal').addEventListener('input', function() {
        const value = this.value.trim();
        if (value.length < 10) {
            showFieldError(this, 'Минимум 10 символов');
        } else if (value.length > 100) {
            showFieldError(this, 'Максимум 100 символов');
        } else {
            clearFieldError(this);
        }
    });

    // Валидация экипажа
    document.querySelectorAll('.crew-input').forEach(input => {
        input.addEventListener('input', function() {
            validateFIO(this);
        });
    });

    function addCrewMember() {
        const container = document.getElementById('crew-container');
        if (container.children.length >= 20) {
            alert('Максимум 20 членов экипажа');
            return;
        }

        const row = document.createElement('div');
        row.className = 'crew-member-row';
        row.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px;';
        row.innerHTML = `
            <input type="text" name="crew[]" placeholder="ФИО члена экипажа" class="crew-input">
            <button type="button" onclick="removeCrewMember(this)" class="btn-remove-crew">❌</button>
        `;
        container.appendChild(row);

        // Добавляем валидацию для нового поля
        row.querySelector('.crew-input').addEventListener('input', function() {
            validateFIO(this);
        });
    }

    function removeCrewMember(button) {
        button.parentElement.remove();
    }

    // Валидация дат
    document.getElementById('end_date').addEventListener('blur', function() {
        if (this.value) {
            const startDate = document.getElementById('start_date').value;
            if (startDate && this.value) {
                const [startDay, startMonth, startYear] = startDate.split('.');
                const [endDay, endMonth, endYear] = this.value.split('.');

                const start = new Date(startYear, startMonth - 1, startDay);
                const end = new Date(endYear, endMonth - 1, endDay);

                if (end < start) {
                    showFieldError(this, 'Дата окончания должна быть позже даты начала');
                }
            }
        }
    });
</script>
{% endblock %}